package strategies

import (
	"testing"

	"github.com/alltilla/sudoku-solver/internal/sudoku"
	. "github.com/alltilla/sudoku-solver/internal/test_utils"
)

func TestHiddenSingle(t *testing.T) {
	const initial_grid_str = `
##=======================##=======================##=======================##
|| 1     |       |       ||   2   |   2   |       ||       |       |       ||
||   5 6 | 4 5 6 |  (3)  || 4 5 6 | 4 5 6 | 4 5 6 ||  (7)  |  (8)  |  (9)  ||
||       |       |       ||       |       |       ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       ||     3 |       |     3 ||     3 |     3 |       ||
||   5   | 4 5   |  (2)  || 4 5   |  (1)  | 4 5   || 4     | 4     |  (6)  ||
|| 7 8 9 | 7 8 9 |       || 7 8 9 |       | 7 8 9 ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1     |       | 1     ||   2 3 |   2 3 |     3 || 1 2 3 | 1   3 |       ||
||     6 | 4 5 6 | 4     || 4   6 | 4   6 | 4   6 || 4     | 4     |  (5)  ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 ||       |       |       ||
##=======================##=======================##=======================##
||   2 3 |       |       ||   2 3 |   2 3 |     3 ||     3 |     3 |       ||
||   5 6 |  (1)  | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 |       |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||     3 |     3 |       || 1   3 |     3 | 1   3 || 1   3 |       | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 |  (2)  | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 |       | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 |   2 3 |       || 1 2 3 |   2 3 | 1   3 || 1   3 | 1   3 | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
##=======================##=======================##=======================##
||       |   2   |       || 1     |       | 1     || 1 2   | 1     |       ||
||  (4)  |   5   |  (6)  ||   5   |   5   |   5   ||   5   |   5   |  (3)  ||
||       |   8 9 |       || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1   3 |     3 |       || 1   3 |     3 |       || 1     | 1     | 1     ||
||   5   |   5   |  (7)  || 4 5 6 |   5 6 |  (2)  || 4 5 6 | 4 5 6 | 4     ||
||   8 9 |   8 9 |       ||   8 9 |   8 9 |       ||   8 9 |   8 9 |   8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1 2 3 |   2 3 | 1     || 1   3 |     3 | 1   3 || 1 2   | 1     | 1 2   ||
||   5   |   5   |   5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
||   8 9 |   8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
##=======================##=======================##=======================##
`

	const expected_grid_str_after_first_call = `
##=======================##=======================##=======================##
||       |       |       ||   2   |   2   |       ||       |       |       ||
||  (1)  | 4 5 6 |  (3)  || 4 5 6 | 4 5 6 | 4 5 6 ||  (7)  |  (8)  |  (9)  ||
||       |       |       ||       |       |       ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       ||     3 |       |     3 ||     3 |     3 |       ||
||   5   | 4 5   |  (2)  || 4 5   |  (1)  | 4 5   || 4     | 4     |  (6)  ||
|| 7 8 9 | 7 8 9 |       || 7 8 9 |       | 7 8 9 ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1     |       | 1     ||   2 3 |   2 3 |     3 || 1 2 3 | 1   3 |       ||
||     6 | 4 5 6 | 4     || 4   6 | 4   6 | 4   6 || 4     | 4     |  (5)  ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 ||       |       |       ||
##=======================##=======================##=======================##
||   2 3 |       |       ||   2 3 |   2 3 |     3 ||     3 |     3 |       ||
||   5 6 |  (1)  | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 |       |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||     3 |     3 |       || 1   3 |     3 | 1   3 || 1   3 |       | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 |  (2)  | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 |       | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 |   2 3 |       || 1 2 3 |   2 3 | 1   3 || 1   3 | 1   3 | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
##=======================##=======================##=======================##
||       |   2   |       || 1     |       | 1     || 1 2   | 1     |       ||
||  (4)  |   5   |  (6)  ||   5   |   5   |   5   ||   5   |   5   |  (3)  ||
||       |   8 9 |       || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1   3 |     3 |       || 1   3 |     3 |       || 1     | 1     | 1     ||
||   5   |   5   |  (7)  || 4 5 6 |   5 6 |  (2)  || 4 5 6 | 4 5 6 | 4     ||
||   8 9 |   8 9 |       ||   8 9 |   8 9 |       ||   8 9 |   8 9 |   8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1 2 3 |   2 3 | 1     || 1   3 |     3 | 1   3 || 1 2   | 1     | 1 2   ||
||   5   |   5   |   5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
||   8 9 |   8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
##=======================##=======================##=======================##
`

	const expected_grid_str_after_second_call = `
##=======================##=======================##=======================##
||       |       |       ||   2   |   2   |       ||       |       |       ||
||  (1)  | 4 5 6 |  (3)  || 4 5 6 | 4 5 6 | 4 5 6 ||  (7)  |  (8)  |  (9)  ||
||       |       |       ||       |       |       ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       ||     3 |       |     3 ||     3 |     3 |       ||
||   5   | 4 5   |  (2)  || 4 5   |  (1)  | 4 5   || 4     | 4     |  (6)  ||
|| 7 8 9 | 7 8 9 |       || 7 8 9 |       | 7 8 9 ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1     |       | 1     ||   2 3 |   2 3 |     3 || 1 2 3 | 1   3 |       ||
||     6 | 4 5 6 | 4     || 4   6 | 4   6 | 4   6 || 4     | 4     |  (5)  ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 ||       |       |       ||
##=======================##=======================##=======================##
||   2 3 |       |       ||   2 3 |   2 3 |     3 ||     3 |     3 |       ||
||   5 6 |  (1)  | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 |       |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||     3 |     3 |       || 1   3 |     3 | 1   3 || 1   3 |       | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 |  (2)  | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 |       | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 |   2 3 |       || 1 2 3 |   2 3 | 1   3 || 1   3 | 1   3 | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
##=======================##=======================##=======================##
||       |   2   |       || 1     |       | 1     || 1 2   | 1     |       ||
||  (4)  |   5   |  (6)  ||   5   |   5   |   5   ||   5   |   5   |  (3)  ||
||       |   8 9 |       || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1   3 |     3 |       || 1   3 |     3 |       || 1     | 1     | 1     ||
||   5   |   5   |  (7)  || 4 5 6 |   5 6 |  (2)  || 4 5 6 | 4 5 6 | 4     ||
||   8 9 |   8 9 |       ||   8 9 |   8 9 |       ||   8 9 |   8 9 |   8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1 2 3 |   2 3 | 1     || 1   3 |     3 | 1   3 || 1 2   | 1     |       ||
||   5   |   5   |   5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 |  (2)  ||
||   8 9 |   8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 |       ||
##=======================##=======================##=======================##
`

	const expected_grid_str_after_third_call = `
##=======================##=======================##=======================##
||       |       |       ||   2   |   2   |       ||       |       |       ||
||  (1)  | 4 5 6 |  (3)  || 4 5 6 | 4 5 6 | 4 5 6 ||  (7)  |  (8)  |  (9)  ||
||       |       |       ||       |       |       ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       ||     3 |       |     3 ||     3 |     3 |       ||
||   5   | 4 5   |  (2)  || 4 5   |  (1)  | 4 5   || 4     | 4     |  (6)  ||
|| 7 8 9 | 7 8 9 |       || 7 8 9 |       | 7 8 9 ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1     |       | 1     ||   2 3 |   2 3 |     3 ||       | 1   3 |       ||
||     6 | 4 5 6 | 4     || 4   6 | 4   6 | 4   6 ||  (2)  | 4     |  (5)  ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 ||       |       |       ||
##=======================##=======================##=======================##
||   2 3 |       |       ||   2 3 |   2 3 |     3 ||     3 |     3 |       ||
||   5 6 |  (1)  | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 |       |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||     3 |     3 |       || 1   3 |     3 | 1   3 || 1   3 |       | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 |  (2)  | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 |       | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 |   2 3 |       || 1 2 3 |   2 3 | 1   3 || 1   3 | 1   3 | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
##=======================##=======================##=======================##
||       |   2   |       || 1     |       | 1     || 1 2   | 1     |       ||
||  (4)  |   5   |  (6)  ||   5   |   5   |   5   ||   5   |   5   |  (3)  ||
||       |   8 9 |       || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1   3 |     3 |       || 1   3 |     3 |       || 1     | 1     | 1     ||
||   5   |   5   |  (7)  || 4 5 6 |   5 6 |  (2)  || 4 5 6 | 4 5 6 | 4     ||
||   8 9 |   8 9 |       ||   8 9 |   8 9 |       ||   8 9 |   8 9 |   8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
|| 1 2 3 |   2 3 | 1     || 1   3 |     3 | 1   3 || 1 2   | 1     |       ||
||   5   |   5   |   5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 |  (2)  ||
||   8 9 |   8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 |       ||
##=======================##=======================##=======================##
`

	grid := sudoku.NewGrid()
	AssertNoError(t, grid.LoadPrettyString(initial_grid_str))

	changed, err := HiddenSingle(grid)
	AssertNoError(t, err)
	AssertChanged(t, changed)
	AssertGridEqualsWithPrettyString(t, grid, expected_grid_str_after_first_call)

	changed, err = HiddenSingle(grid)
	AssertNoError(t, err)
	AssertChanged(t, changed)
	AssertGridEqualsWithPrettyString(t, grid, expected_grid_str_after_second_call)

	changed, err = HiddenSingle(grid)
	AssertNoError(t, err)
	AssertChanged(t, changed)
	AssertGridEqualsWithPrettyString(t, grid, expected_grid_str_after_third_call)

	// TODO: There are hidden singles still to find in this grid, so we cannot assert for the next call to not change. Find a better initial grid.
}

func TestHiddenSingleError(t *testing.T) {
	const initial_grid_str = `
##=======================##=======================##=======================##
||       |       |       ||   2   |   2   |       ||       |       |       ||
||   5 6 | 4 5 6 |  (3)  || 4 5 6 | 4 5 6 | 4 5 6 ||  (7)  |  (8)  |  (9)  ||
||       |       |       ||       |       |       ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       ||     3 |       |     3 ||     3 |     3 |       ||
||   5   | 4 5   |  (2)  || 4 5   |  (1)  | 4 5   || 4     | 4     |  (6)  ||
|| 7 8 9 | 7 8 9 |       || 7 8 9 |       | 7 8 9 ||       |       |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       | 1     ||   2 3 |   2 3 |     3 || 1 2 3 | 1   3 |       ||
||     6 | 4 5 6 | 4     || 4   6 | 4   6 | 4   6 || 4     | 4     |  (5)  ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 ||       |       |       ||
##=======================##=======================##=======================##
||   2 3 |       |       ||   2 3 |   2 3 |     3 ||     3 |     3 |       ||
||   5 6 |  (1)  | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 |       |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||     3 |     3 |       || 1   3 |     3 | 1   3 || 1   3 |       | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 |  (2)  | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 |       | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 |   2 3 |       || 1 2 3 |   2 3 | 1   3 || 1   3 | 1   3 | 1     ||
||   5 6 | 4 5 6 | 4 5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
|| 7 8 9 | 7 8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
##=======================##=======================##=======================##
||       |   2   |       || 1     |       | 1     || 1 2   | 1     |       ||
||  (4)  |   5   |  (6)  ||   5   |   5   |   5   ||   5   |   5   |  (3)  ||
||       |   8 9 |       || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 |       ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||     3 |     3 |       || 1   3 |     3 |       || 1     | 1     | 1     ||
||   5   |   5   |  (7)  || 4 5 6 |   5 6 |  (2)  || 4 5 6 | 4 5 6 | 4     ||
||   8 9 |   8 9 |       ||   8 9 |   8 9 |       ||   8 9 |   8 9 |   8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |   2 3 |       ||     3 |     3 |     3 ||   2   |       |   2   ||
||  (1)  |   5   |   5   || 4 5 6 |   5 6 | 4 5 6 || 4 5 6 | 4 5 6 | 4     ||
||       |   8 9 |   8 9 || 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7 8 9 | 7 8   ||
##=======================##=======================##=======================##
`

	grid := sudoku.NewGrid()
	AssertNoError(t, grid.LoadPrettyString(initial_grid_str))

	changed, err := HiddenSingle(grid)
	AssertError(t, err)
	AssertNoChanged(t, changed)
	AssertGridEqualsWithPrettyString(t, grid, initial_grid_str)
}
