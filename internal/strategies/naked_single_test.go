package strategies

import (
	"testing"

	"github.com/alltilla/sudoku-solver/internal/sudoku"
	. "github.com/alltilla/sudoku-solver/internal/test_utils"
)

func TestNakedSingle(t *testing.T) {
	const initial_grid_str = `
##=======================##=======================##=======================##
||       |       |       ||       |       |       ||       |       |       ||
||  (1)  |  (2)  |  (3)  ||       |       |       || 4 5 6 | 4 5 6 | 4 5 6 ||
||       |       |       || 7 8 9 | 7     |     9 || 7 8 9 | 7 8 9 | 7 8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       ||       |       |       || 1 2 3 | 1 2 3 | 1 2 3 ||
||       |       |       ||  (4)  |  (5)  |  (6)  ||       |       |       ||
|| 7 8 9 | 7 8 9 | 7 8 9 ||       |       |       || 7 8 9 | 7 8 9 | 7 8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||       |       |       || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7     |     9 || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 |       || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 |  (7)  || 4 5 6 | 4 5 6 | 4 5 6 ||
||   8 9 |   8 9 |   8 9 ||     9 |       |       ||   8 9 |   8 9 |   8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 |       || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 |  (8)  || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7   9 | 7   9 | 7   9 ||     9 |       |       || 7   9 | 7   9 | 7   9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 ||     9 |       |     9 || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
||   2 3 | 1   3 | 1 2   || 1 2 3 |       | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 |  (9)  | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8   | 7 8   | 7 8   || 7     |       |       || 7 8   | 7 8   | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 |       | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 |  (8)  | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7   9 | 7   9 | 7   9 || 7     |       |       || 7   9 | 7   9 | 7   9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 || 7     | 7     |       || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
`

	const expected_grid_str_after_first_call = `
##=======================##=======================##=======================##
||       |       |       ||       |       |       ||       |       |       ||
||  (1)  |  (2)  |  (3)  ||       |  (7)  |       || 4 5 6 | 4 5 6 | 4 5 6 ||
||       |       |       || 7 8 9 |       |     9 || 7 8 9 | 7 8 9 | 7 8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       ||       |       |       || 1 2 3 | 1 2 3 | 1 2 3 ||
||       |       |       ||  (4)  |  (5)  |  (6)  ||       |       |       ||
|| 7 8 9 | 7 8 9 | 7 8 9 ||       |       |       || 7 8 9 | 7 8 9 | 7 8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||       |       |       || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7     |     9 || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 |       || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 |  (7)  || 4 5 6 | 4 5 6 | 4 5 6 ||
||   8 9 |   8 9 |   8 9 ||     9 |       |       ||   8 9 |   8 9 |   8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 |       || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 |  (8)  || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7   9 | 7   9 | 7   9 ||     9 |       |       || 7   9 | 7   9 | 7   9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 ||     9 |       |     9 || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
||   2 3 | 1   3 | 1 2   || 1 2 3 |       | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 |  (9)  | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8   | 7 8   | 7 8   || 7     |       |       || 7 8   | 7 8   | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 |       | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 |  (8)  | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7   9 | 7   9 | 7   9 || 7     |       |       || 7   9 | 7   9 | 7   9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 || 7     | 7     |       || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
`

	const expected_grid_str_after_second_call = `
##=======================##=======================##=======================##
||       |       |       ||       |       |       ||       |       |       ||
||  (1)  |  (2)  |  (3)  ||       |  (7)  |  (9)  || 4 5 6 | 4 5 6 | 4 5 6 ||
||       |       |       || 7 8 9 |       |       || 7 8 9 | 7 8 9 | 7 8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       ||       |       |       || 1 2 3 | 1 2 3 | 1 2 3 ||
||       |       |       ||  (4)  |  (5)  |  (6)  ||       |       |       ||
|| 7 8 9 | 7 8 9 | 7 8 9 ||       |       |       || 7 8 9 | 7 8 9 | 7 8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||       |       |       || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7     |     9 || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 |       || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 |  (7)  || 4 5 6 | 4 5 6 | 4 5 6 ||
||   8 9 |   8 9 |   8 9 ||     9 |       |       ||   8 9 |   8 9 |   8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 |       || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 |  (8)  || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7   9 | 7   9 | 7   9 ||     9 |       |       || 7   9 | 7   9 | 7   9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 ||     9 |       |     9 || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
||   2 3 | 1   3 | 1 2   || 1 2 3 |       | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 |  (9)  | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8   | 7 8   | 7 8   || 7     |       |       || 7 8   | 7 8   | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 |       | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 |  (8)  | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7   9 | 7   9 | 7   9 || 7     |       |       || 7   9 | 7   9 | 7   9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 || 7     | 7     |       || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
`

	grid := sudoku.NewGrid()
	AssertNoError(t, grid.LoadPrettyString(initial_grid_str))

	changed, err := NakedSingle(grid)
	AssertNoError(t, err)
	AssertChanged(t, changed)
	AssertGridEqualsWithPrettyString(t, grid, expected_grid_str_after_first_call)

	changed, err = NakedSingle(grid)
	AssertNoError(t, err)
	AssertChanged(t, changed)
	AssertGridEqualsWithPrettyString(t, grid, expected_grid_str_after_second_call)

	changed, err = NakedSingle(grid)
	AssertNoError(t, err)
	AssertNoChanged(t, changed)
	AssertGridEqualsWithPrettyString(t, grid, expected_grid_str_after_second_call)
}

func TestNakedSinglesError(t *testing.T) {
	const initial_grid_str = `
##=======================##=======================##=======================##
||       |       |       ||       |       |       ||       |       |       ||
||  (1)  |  (2)  |  (3)  ||       |       |       || 4 5 6 | 4 5 6 | 4 5 6 ||
||       |       |       || 7 8 9 | 7 8   |       || 7 8 9 | 7 8 9 | 7 8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       ||       |       |       || 1 2 3 | 1 2 3 | 1 2 3 ||
||       |       |       ||  (4)  |  (5)  |  (6)  ||       |       |       ||
|| 7 8 9 | 7 8 9 | 7 8 9 ||       |       |       || 7 8 9 | 7 8 9 | 7 8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||       |       |       || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||       |       |       || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 || 7 8 9 | 7     |       || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 |       || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 |  (7)  || 4 5 6 | 4 5 6 | 4 5 6 ||
||   8 9 |   8 9 |   8 9 ||       |       |       ||   8 9 |   8 9 |   8 9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 |       || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 |  (8)  || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7   9 | 7   9 | 7   9 ||       |       |       || 7   9 | 7   9 | 7   9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 |       || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 |  (9)  || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8   | 7 8   | 7 8   ||       |       |       || 7 8   | 7 8   | 7 8   ||
##=======================##=======================##=======================##
||   2 3 | 1   3 | 1 2   || 1 2 3 |       | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 |  (9)  | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8   | 7 8   | 7 8   || 7 8   |       |       || 7 8   | 7 8   | 7 8   ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7   9 | 7   9 | 7   9 || 7 8   | 7 8   |       || 7   9 | 7   9 | 7   9 ||
||-------+-------+-------||-------+-------+-------||-------+-------+-------||
||   2 3 | 1   3 | 1 2   || 1 2 3 | 1 2 3 | 1 2 3 || 1 2 3 | 1 2 3 | 1 2 3 ||
|| 4 5 6 | 4 5 6 | 4 5 6 ||   5 6 | 4   6 | 4 5   || 4 5 6 | 4 5 6 | 4 5 6 ||
|| 7 8 9 | 7 8 9 | 7 8 9 || 7 8   | 7 8   |       || 7 8 9 | 7 8 9 | 7 8 9 ||
##=======================##=======================##=======================##
`

	grid := sudoku.NewGrid()
	AssertNoError(t, grid.LoadPrettyString(initial_grid_str))

	changed, err := NakedSingle(grid)
	AssertError(t, err)
	AssertNoChanged(t, changed)
	AssertGridEqualsWithPrettyString(t, grid, initial_grid_str)
}
